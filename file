# Projet Inception - Structure complète

## Structure des fichiers

```
inception/
├── Makefile
├── README.md
├── USER_DOC.md
├── DEV_DOC.md
├── secrets/
│   ├── credentials.txt
│   ├── db_password.txt
│   └── db_root_password.txt
└── srcs/
    ├── .env
    ├── docker-compose.yml
    └── requirements/
        ├── mariadb/
        │   ├── Dockerfile
        │   ├── .dockerignore
        │   ├── conf/
        │   │   └── 50-server.cnf
        │   └── tools/
        │       └── init-db.sh
        ├── nginx/
        │   ├── Dockerfile
        │   ├── .dockerignore
        │   ├── conf/
        │   │   └── nginx.conf
        │   └── tools/
        │       └── setup-ssl.sh
        └── wordpress/
            ├── Dockerfile
            ├── .dockerignore
            ├── conf/
            │   └── www.conf
            └── tools/
                └── setup-wordpress.sh
```

---

## 1. Makefile (racine)

```makefile
COMPOSE_FILE = srcs/docker-compose.yml
DATA_DIR = /home/$(USER)/data

all: build up

build:
	@mkdir -p $(DATA_DIR)/wordpress
	@mkdir -p $(DATA_DIR)/mariadb
	@docker-compose -f $(COMPOSE_FILE) build

up:
	@docker-compose -f $(COMPOSE_FILE) up -d

down:
	@docker-compose -f $(COMPOSE_FILE) down

clean: down
	@docker-compose -f $(COMPOSE_FILE) down -v
	@docker system prune -af

fclean: clean
	@sudo rm -rf $(DATA_DIR)/wordpress
	@sudo rm -rf $(DATA_DIR)/mariadb

re: fclean all

logs:
	@docker-compose -f $(COMPOSE_FILE) logs -f

status:
	@docker-compose -f $(COMPOSE_FILE) ps

.PHONY: all build up down clean fclean re logs status
```

---

## 2. srcs/.env

```env
DOMAIN_NAME=login.42.fr

# MariaDB Configuration
MYSQL_ROOT_PASSWORD=root_secure_password_123
MYSQL_DATABASE=wordpress_db
MYSQL_USER=wp_user
MYSQL_PASSWORD=wp_secure_password_456

# WordPress Configuration
WP_TITLE=My Inception Site
WP_ADMIN_USER=wpadmin
WP_ADMIN_PASSWORD=admin_secure_pass_789
WP_ADMIN_EMAIL=admin@login.42.fr
WP_USER=wpuser
WP_USER_EMAIL=user@login.42.fr
WP_USER_PASSWORD=user_secure_pass_101

# PHP Configuration
PHP_FPM_HOST=wordpress:9000
```

---

## 3. srcs/docker-compose.yml

```yaml
version: '3.8'

services:
  mariadb:
    container_name: mariadb
    build:
      context: ./requirements/mariadb
      dockerfile: Dockerfile
    image: mariadb:inception
    env_file:
      - .env
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - inception_network
    restart: unless-stopped

  wordpress:
    container_name: wordpress
    build:
      context: ./requirements/wordpress
      dockerfile: Dockerfile
    image: wordpress:inception
    env_file:
      - .env
    volumes:
      - wordpress_data:/var/www/html
    networks:
      - inception_network
    depends_on:
      - mariadb
    restart: unless-stopped

  nginx:
    container_name: nginx
    build:
      context: ./requirements/nginx
      dockerfile: Dockerfile
    image: nginx:inception
    env_file:
      - .env
    ports:
      - "443:443"
    volumes:
      - wordpress_data:/var/www/html
    networks:
      - inception_network
    depends_on:
      - wordpress
    restart: unless-stopped

volumes:
  mariadb_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${USER}/data/mariadb
  wordpress_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${USER}/data/wordpress

networks:
  inception_network:
    driver: bridge
```

---

## 4. MariaDB - Dockerfile

```dockerfile
FROM debian:bullseye

RUN apt-get update && apt-get install -y \
    mariadb-server \
    mariadb-client \
    && rm -rf /var/lib/apt/lists/*

COPY conf/50-server.cnf /etc/mysql/mariadb.conf.d/50-server.cnf
COPY tools/init-db.sh /usr/local/bin/init-db.sh

RUN chmod +x /usr/local/bin/init-db.sh && \
    mkdir -p /var/run/mysqld && \
    chown -R mysql:mysql /var/run/mysqld && \
    chmod 755 /var/run/mysqld

EXPOSE 3306

ENTRYPOINT ["/usr/local/bin/init-db.sh"]
```

---

## 5. MariaDB - conf/50-server.cnf

```ini
[mysqld]
user                    = mysql
pid-file                = /var/run/mysqld/mysqld.pid
socket                  = /var/run/mysqld/mysqld.sock
port                    = 3306
basedir                 = /usr
datadir                 = /var/lib/mysql
tmpdir                  = /tmp
bind-address            = 0.0.0.0
skip-networking         = false
```

---

## 6. MariaDB - tools/init-db.sh

```bash
#!/bin/bash

if [ ! -d "/var/lib/mysql/mysql" ]; then
    echo "Initializing MariaDB data directory..."
    mysql_install_db --user=mysql --datadir=/var/lib/mysql
    
    mysqld --user=mysql --bootstrap << EOF
USE mysql;
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}';
CREATE DATABASE IF NOT EXISTS ${MYSQL_DATABASE};
CREATE USER IF NOT EXISTS '${MYSQL_USER}'@'%' IDENTIFIED BY '${MYSQL_PASSWORD}';
GRANT ALL PRIVILEGES ON ${MYSQL_DATABASE}.* TO '${MYSQL_USER}'@'%';
FLUSH PRIVILEGES;
EOF
    echo "MariaDB initialized successfully."
else
    echo "MariaDB data directory already exists."
fi

exec mysqld --user=mysql --console
```

---

## 7. NGINX - Dockerfile

```dockerfile
FROM debian:bullseye

RUN apt-get update && apt-get install -y \
    nginx \
    openssl \
    && rm -rf /var/lib/apt/lists/*

COPY conf/nginx.conf /etc/nginx/nginx.conf
COPY tools/setup-ssl.sh /usr/local/bin/setup-ssl.sh

RUN chmod +x /usr/local/bin/setup-ssl.sh && \
    mkdir -p /etc/nginx/ssl

EXPOSE 443

ENTRYPOINT ["/usr/local/bin/setup-ssl.sh"]
```

---

## 8. NGINX - conf/nginx.conf

```nginx
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        
        server_name login.42.fr;
        
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        root /var/www/html;
        index index.php index.html;
        
        location / {
            try_files $uri $uri/ /index.php?$args;
        }
        
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass wordpress:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }
}
```

---

## 9. NGINX - tools/setup-ssl.sh

```bash
#!/bin/bash

if [ ! -f /etc/nginx/ssl/nginx.crt ]; then
    echo "Generating self-signed SSL certificate..."
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
        -keyout /etc/nginx/ssl/nginx.key \
        -out /etc/nginx/ssl/nginx.crt \
        -subj "/C=FR/ST=Paris/L=Paris/O=42/OU=42/CN=login.42.fr"
    echo "SSL certificate generated."
fi

exec nginx -g "daemon off;"
```

---

## 10. WordPress - Dockerfile

```dockerfile
FROM debian:bullseye

RUN apt-get update && apt-get install -y \
    php7.4-fpm \
    php7.4-mysql \
    php7.4-curl \
    php7.4-gd \
    php7.4-mbstring \
    php7.4-xml \
    php7.4-xmlrpc \
    php7.4-zip \
    curl \
    mariadb-client \
    && rm -rf /var/lib/apt/lists/*

RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && \
    chmod +x wp-cli.phar && \
    mv wp-cli.phar /usr/local/bin/wp

COPY conf/www.conf /etc/php/7.4/fpm/pool.d/www.conf
COPY tools/setup-wordpress.sh /usr/local/bin/setup-wordpress.sh

RUN chmod +x /usr/local/bin/setup-wordpress.sh && \
    mkdir -p /var/www/html && \
    chown -R www-data:www-data /var/www/html

EXPOSE 9000

ENTRYPOINT ["/usr/local/bin/setup-wordpress.sh"]
```

---

## 11. WordPress - conf/www.conf

```ini
[www]
user = www-data
group = www-data
listen = 9000
listen.owner = www-data
listen.group = www-data
pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
```

---

## 12. WordPress - tools/setup-wordpress.sh

```bash
#!/bin/bash

cd /var/www/html

if [ ! -f wp-config.php ]; then
    echo "Waiting for MariaDB to be ready..."
    until mysql -h mariadb -u"${MYSQL_USER}" -p"${MYSQL_PASSWORD}" -e "SELECT 1" &>/dev/null; do
        sleep 2
    done
    
    echo "Downloading WordPress..."
    wp core download --allow-root
    
    echo "Configuring WordPress..."
    wp config create \
        --dbname="${MYSQL_DATABASE}" \
        --dbuser="${MYSQL_USER}" \
        --dbpass="${MYSQL_PASSWORD}" \
        --dbhost=mariadb \
        --allow-root
    
    echo "Installing WordPress..."
    wp core install \
        --url="${DOMAIN_NAME}" \
        --title="${WP_TITLE}" \
        --admin_user="${WP_ADMIN_USER}" \
        --admin_password="${WP_ADMIN_PASSWORD}" \
        --admin_email="${WP_ADMIN_EMAIL}" \
        --allow-root
    
    echo "Creating additional user..."
    wp user create "${WP_USER}" "${WP_USER_EMAIL}" \
        --user_pass="${WP_USER_PASSWORD}" \
        --role=author \
        --allow-root
    
    echo "WordPress setup completed."
fi

chown -R www-data:www-data /var/www/html

exec php-fpm7.4 -F
```

---

## 13. README.md

```markdown
# Inception

*This project has been created as part of the 42 curriculum by [your_login].*

## Description

Inception is a system administration project that involves setting up a small infrastructure using Docker. The project consists of multiple services running in separate containers: NGINX with TLS, WordPress with PHP-FPM, and MariaDB. All services are orchestrated using Docker Compose and communicate through a dedicated Docker network.

## Instructions

### Prerequisites
- A Virtual Machine (recommended: VirtualBox or VMware)
- Docker and Docker Compose installed
- At least 4GB of RAM and 10GB of disk space

### Installation

1. Clone the repository
2. Update `/etc/hosts` to point your login to localhost:
   ```
   127.0.0.1 login.42.fr
   ```
3. Create the data directories:
   ```bash
   make
   ```

### Usage

- Start the infrastructure: `make up`
- Stop the infrastructure: `make down`
- View logs: `make logs`
- Check status: `make status`
- Complete cleanup: `make fclean`

Access the website at: `https://login.42.fr`

## Project Description

### Docker vs Virtual Machines
Docker containers share the host OS kernel, making them lighter and faster than VMs which run full guest operating systems. Containers provide process isolation while VMs provide complete system isolation.

### Secrets vs Environment Variables
Secrets offer encrypted storage for sensitive data with access controls, while environment variables store plain text data. This project uses a `.env` file for configuration and a `secrets/` directory for credentials.

### Docker Network vs Host Network
Docker networks provide isolated communication between containers with custom DNS resolution. Host networking shares the host's network stack, offering better performance but less isolation.

### Docker Volumes vs Bind Mounts
Named volumes are managed by Docker and offer better portability and backup capabilities. Bind mounts link to specific host paths, providing direct access to host filesystems.

## Resources

### Documentation
- [Docker Documentation](https://docs.docker.com/)
- [Docker Compose Reference](https://docs.docker.com/compose/)
- [NGINX Documentation](https://nginx.org/en/docs/)
- [WordPress CLI](https://wp-cli.org/)
- [MariaDB Documentation](https://mariadb.com/kb/en/documentation/)

### AI Usage
AI was used to:
- Generate initial Dockerfile templates
- Troubleshoot shell script syntax
- Review Docker Compose configuration best practices
- Suggest security improvements for SSL/TLS configuration

All AI-generated content was reviewed, tested, and adapted to meet project requirements.
```

---

## Notes importantes

Remplacez `login` par votre login 42 dans tous les fichiers.
Modifiez les mots de passe dans le fichier `.env`.
Assurez-vous que les dossiers `/home/login/data` existent avant de lancer.
